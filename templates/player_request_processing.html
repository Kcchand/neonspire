{% extends "base.html" %}
{% block content %}
<div class="shell">
  <div class="panel" style="text-align:center; padding:40px 20px;">
    <h2 style="margin-bottom:10px;">
      Creating your {{ game.name if game else 'game' }} ID…
    </h2>
    <p style="margin-bottom:25px;">
      Please keep this page open. This usually takes less than a minute.
    </p>

    <div class="spinner" style="
        margin: 0 auto 10px;
        width: 40px; height: 40px;
        border-radius: 50%;
        border: 4px solid rgba(255,255,255,0.2);
        border-top-color: #00ff99;
        animation: spin 0.8s linear infinite;
    "></div>

    <p class="muted">We’ll automatically redirect you once your login is ready.</p>
  </div>
</div>

<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>

<script>
(function() {
  const pollUrl = "{{ url_for('playerbp.request_status_json', req_id=req.id) }}";
  const doneUrl = "{{ url_for('playerbp.mylogin') }}";

  function poll() {
    fetch(pollUrl, {cache: "no-store"})
      .then(r => r.json())
      .then(data => {
        if (!data.ok) {
          setTimeout(poll, 5000);
          return;
        }

        if (data.status === "APPROVED") {
          window.location = doneUrl;
        } else if (data.status === "FAILED") {
          window.location = doneUrl;
        } else {
          setTimeout(poll, 4000);
        }
      })
      .catch(() => {
        setTimeout(poll, 6000);
      });
  }

  setTimeout(poll, 3000);
})();
</script>
{% endblock %}