{% extends "base.html" %}

{% block hero %}
{# --- Scrolling News Banner (admin-controlled) --- #}
{% set has_any = (promo_line1 or promo_line2 or (bonus_percent is not none) or (settings and settings.bonus_percent)) %}
{% if has_any %}
<div class="news-ticker" aria-label="Site announcements">
  <div class="news-mask news-mask--left" aria-hidden="true"></div>

  <div class="shell news-inner">
    <div class="news-track" id="newsTrack">
      {% if promo_line1 %}
        <span class="news-item">{{ promo_line1 }}</span>
      {% endif %}
      {% if promo_line2 %}
        {% if promo_line1 %}<span class="news-sep">‚Ä¢</span>{% endif %}
        <span class="news-item">{{ promo_line2 }}</span>
      {% endif %}
      {% set bp = bonus_percent if bonus_percent is not none else (settings.bonus_percent if settings else 0) %}
      {% if bp and bp|int > 0 %}
        <span class="news-sep">‚Ä¢</span>
        <span class="news-item">üíé +{{ bp|int }}% bonus on credit loads</span>
      {% endif %}
    </div>
  </div>

  <div class="news-mask news-mask--right" aria-hidden="true"></div>
</div>

<style>
/* --- Ticker Banner --- */
.news-ticker{
  position:relative;
  width:100%;
  background: rgba(18,20,25,.95);
  border-bottom: 1px solid var(--stroke, #2a2e37);
  overflow:hidden;
  box-shadow: 0 1px 0 rgba(255,255,255,.03) inset, 0 8px 24px rgba(0,0,0,.18);
}
.news-inner{ position:relative; white-space:nowrap; overflow:hidden; padding:10px 0; }
.news-track{ display:inline-block; will-change: transform; animation: news-marquee var(--marquee-duration, 20s) linear infinite; }
.news-item{ display:inline-flex; align-items:center; gap:.35rem; padding:0 .75rem; font-weight:700; letter-spacing:.2px; }
.news-sep{ opacity:.55; padding:0 .35rem; }
.news-mask{ position:absolute; top:0; bottom:0; width:60px; pointer-events:none; z-index:1; background: linear-gradient(to right, rgba(18,20,25,1) 0%, rgba(18,20,25,0) 100%); }
.news-mask--right{ right:0; transform: scaleX(-1); }
.news-mask--left{ left:0; }
@keyframes news-marquee{ 0%{ transform: translateX(0); } 100%{ transform: translateX(var(--marquee-distance, -50%)); } }
.news-ticker:hover .news-track{ animation-play-state: paused; }
@media (prefers-reduced-motion: reduce){ .news-track{ animation: none; } }

/* --- page-scoped mobile helpers (desktop untouched) --- */
.hide-mobile{ display:block !important; }
.show-mobile{ display:none !important; }
@media (max-width: 768px){
  .hide-mobile{ display:none !important; }
  .show-mobile{ display:block !important; }
}
</style>

<script>
/* Responsive marquee */
document.addEventListener("DOMContentLoaded", () => {
  const track = document.getElementById("newsTrack");
  if(!track) return;

  const container = track.parentElement;
  const baseHTML = track.innerHTML.trim();
  if (!baseHTML) return;

  let clones = 0, maxClones = 10;
  while (track.scrollWidth < container.clientWidth * 2 && clones < maxClones) {
    track.insertAdjacentHTML("beforeend", baseHTML);
    clones++;
  }

  const pxPerSec = 120;
  const distance = track.scrollWidth / 2;
  const duration = Math.max(12, Math.round(distance / pxPerSec));
  track.style.setProperty("--marquee-distance", `-${distance}px`);
  track.style.setProperty("--marquee-duration", `${duration}s`);

  let t;
  window.addEventListener("resize", () => {
    clearTimeout(t);
    t = setTimeout(() => {
      track.style.animation = "none";
      track.innerHTML = baseHTML;
      let clones2 = 0;
      while (track.scrollWidth < container.clientWidth * 2 && clones2 < maxClones) {
        track.insertAdjacentHTML("beforeend", baseHTML);
        clones2++;
      }
      const d2 = track.scrollWidth / 2;
      const dur2 = Math.max(12, Math.round(d2 / 120));
      track.style.setProperty("--marquee-distance", `-${d2}px`);
      track.style.setProperty("--marquee-duration", `${dur2}s`);
      requestAnimationFrame(() => { track.style.animation = ""; });
    }, 150);
  });
});
</script>
{% endif %}
{% endblock %}

{% block content %}
<style>
  /* ====== Credits pill near the game icon ====== */
  .game-card .game-media{position:relative}
  .gv-balance-pill{
    position:absolute; left:14px; top:14px;
    padding:5px 12px; border-radius:999px;
    font-size:12px; font-weight:800; letter-spacing:.2px;
    color:#fff; background:linear-gradient(135deg,#1ad1a5,#16c2ff);
    box-shadow:0 10px 26px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.06) inset;
    backdrop-filter:saturate(120%) blur(2px);
    pointer-events:none; user-select:none;
  }
  @media (max-width:520px){
    .gv-balance-pill{font-size:11px; padding:4px 10px; left:10px; top:10px}
  }

  /* ====== per-card inline loader for "Request ID" ====== */
  .game-card {
    position: relative;
  }
  .gc-card-loading {
    position: absolute;
    inset: 0;
    background: rgba(7, 9, 12, .72);
    backdrop-filter: blur(1.5px);
    display: none;
    align-items: center;
    justify-content: center;
    gap: 10px;
    z-index: 50;
    border-radius: 16px;
    text-align: center;
    flex-direction: column;
    font-size: 12px;
  }
  .gc-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,.2);
    border-top-color: #12d9a1;
    border-radius: 999px;
    animation: gcspin .65s linear infinite;
  }
  @keyframes gcspin {
    to { transform: rotate(360deg); }
  }

  /* ====== tiny toast for ID messages ====== */
  .id-toast{
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    padding:10px 14px;
    border-radius:999px;
    background:rgba(15,23,42,.98);
    color:#f9fafb;
    font-size:13px;
    display:none;
    align-items:center;
    gap:8px;
    box-shadow:0 10px 30px rgba(0,0,0,.5);
    z-index:9999;
  }
  .id-toast-icon{font-size:15px;}
  @media (max-width:480px){
    .id-toast{
      left:8px;
      right:8px;
      transform:none;
      border-radius:999px;
      justify-content:center;
    }
  }


  
  .bonus-card {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .bonus-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  }
  
  .bonus-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, currentColor, transparent);
    opacity: 0.3;
  }
  
  .bonus-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 16px;
  }
  
  .btn-success {
    background: linear-gradient(135deg, #10b981, #34d399);
    border: none;
    color: white;
  }
  
  .btn-success:hover {
    background: linear-gradient(135deg, #059669, #10b981);
  }
  
  .bonus-timer {
    font-size: 14px;
    color: #fbbf24;
    margin-top: 8px;
    font-weight: 500;
  }
</style>

<div class="shell grid-page" style="margin-top:14px">

  <!-- Small toast for ID status -->
  <div id="idToast" class="id-toast" role="status" aria-live="polite">
    <span class="id-toast-icon">‚ö†Ô∏è</span>
    <span id="idToastText"></span>
  </div>

  {% if not is_telegram %}
  <!-- Left rail (hidden in Telegram mini app) -->
  <aside class="rail">
    <div class="rail-card">
      <div class="rail-title">Add Funds</div>
      {% if current_user.is_authenticated %}
        <a class="btn btn-primary btn-wide" href="{{ url_for('playerbp.deposit_step1') }}">Add Credits</a>
        <div class="method-row" style="margin-top:10px">
          <a class="btn btn-mini" href="{{ url_for('playerbp.deposit_step1') }}">Chime</a>
          <a class="btn btn-mini" href="{{ url_for('playerbp.deposit_step1') }}">Crypto</a>
        </div>
        <div class="rail-sub">Crypto &amp; Chime supported.</div>
      {% else %}
        <a class="btn btn-primary btn-wide" href="{{ url_for('auth.register_get') }}">Create account to add funds</a>
        <div class="rail-sub">Sign in to deposit with Crypto or Chime.</div>
      {% endif %}
    </div>

    <div class="rail-card">
      <div class="rail-title">Withdraw</div>
      {% if current_user.is_authenticated %}
        <a class="btn btn-wide" href="{{ url_for('playerbp.withdraw_get') }}">Request Payout</a>
        {% if settings %}
          <div class="rail-sub">Min: {{ settings.min_redeem or 0 }} ‚Ä¢ Max: {{ settings.max_redeem or 0 }}</div>
        {% endif %}
      {% else %}
        <a class="btn btn-wide" href="{{ url_for('auth.login_get') }}">Sign in</a>
        <div class="rail-sub">Withdrawals require an account.</div>
      {% endif %}
    </div>

    <div class="rail-card hide-mobile" id="contact">
      <div class="rail-title">Contact Us</div>
      {% set wa = (settings.whatsapp_url if settings and settings.whatsapp_url else 'https://wa.me/+12342795662') %}
      {% set tg = (settings.telegram_url if settings and settings.telegram_url else 'https://t.me/Neonspire') %}
      {% set fb = (settings.facebook_url if settings and settings.facebook_url else 'https://www.facebook.com/neonspirecas') %}
      {% set ig = (settings.instagram_url if settings and settings.instagram_url else 'https://instagram.com/neonspirecasino') %}
      <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <a class="btn btn-mini btn-wide" href="{{ wa }}" target="_blank" rel="noopener noreferrer" data-external="1">WhatsApp</a>
        <a class="btn btn-mini btn-wide" href="{{ tg }}" target="_blank" rel="noopener noreferrer" data-external="1">Telegram</a>
        <a class="btn btn-mini btn-wide" href="{{ fb }}" target="_blank" rel="noopener noreferrer" data-external="1">Facebook</a>
        <a class="btn btn-mini btn-wide" href="{{ ig }}" target="_blank" rel="noopener noreferrer" data-external="1">Instagram</a>
      </div>
      <div class="rail-sub" style="margin-top:8px">We're available 24/7.</div>
    </div>

    {% if current_user.is_authenticated and ((current_user.role or '')|upper == 'PLAYER') %}
    <div class="rail-card hide-mobile">
      <div class="rail-title">Referral Program</div>
      <button type="button" class="btn btn-wide js-ref-btn">Get My Link</button>
    </div>
    {% endif %}
  </aside>
  {% endif %}

  <!-- Main column -->
  <section>
    <div class="panel">
      <div class="panel-head">
        <div class="h3">Today's Trending</div>
        <div class="muted">Updated live</div>
      </div>
      <div class="chip-row">
        {% for tg in trending_games %}
          <span class="chip" title="{{ tg.name }}">
            {% if tg.icon_url %}<img class="chip-icon" src="{{ tg.icon_url }}" alt="{{ tg.name }}">{% endif %}
            {{ tg.name }}
          </span>
        {% else %}
          <span class="muted">No games yet.</span>
        {% endfor %}
      </div>
    </div>
<!-- TODAY'S BONUS SECTION - COMPACT NEON -->
{% if current_user.is_authenticated %}
<div class="panel neon-bonus-panel">
  <div class="neon-bonus-header">
    <div class="h3 neon-glow-text">üéÅ Today's Bonus</div>
    
  </div>
  
  <div class="neon-bonus-cards">
  <!-- SIGN-UP BONUS CARD -->
  <div class="neon-bonus-card {% if current_user.is_authenticated and not current_user.signup_bonus_claimed %}neon-signup{% else %}neon-claimed{% endif %}">
  <div class="neon-bonus-top">
    <span class="neon-bonus-label">Sign‚ÄëUp</span>
    <span class="neon-bonus-badge {% if current_user.is_authenticated and not current_user.signup_bonus_claimed %}neon-eligible{% else %}neon-used{% endif %}">
      {% if current_user.is_authenticated and not current_user.signup_bonus_claimed %}
        üíé
      {% else %}
        ‚úì
      {% endif %}
    </span>
  </div>
  <div class="neon-bonus-percent">{{ bonus_settings.signup_percentage if bonus_settings else 100 }}%</div>
  <div class="neon-bonus-max">Min Deposit: $5</div>
  <div class="neon-bonus-status {% if current_user.is_authenticated and not current_user.signup_bonus_claimed %}neon-pulse{% endif %}">
    {% if current_user.is_authenticated and not current_user.signup_bonus_claimed %}
      ELIGIBLE
    {% else %}
      CLAIMED
    {% endif %}
  </div>
  <!-- Only keep "Applied automatically" line -->
  <div class="neon-bonus-info-inside">
    <div class="neon-bonus-auto-inside">‚úì Applied automatically</div>
  </div>
</div>
    
 <!-- REGULAR BONUS CARD -->
<div class="neon-bonus-card neon-regular">
  <div class="neon-bonus-top">
    <span class="neon-bonus-label">Regular</span>
    <span class="neon-bonus-badge neon-active">‚ö°</span>
  </div>
  <div class="neon-bonus-percent">{{ bonus_settings.regular_percentage if bonus_settings else 50 }}%</div>
  <div class="neon-bonus-max">Min Deposit: $5</div>
  <div class="neon-bonus-status neon-active neon-pulse">ACTIVE</div>
  <!-- Only keep "Applied automatically" line -->
  <div class="neon-bonus-info-inside">
    <div class="neon-bonus-auto-inside">‚úì Applied automatically</div>
  </div>
</div>
  </div>
  
 
</div>

<style>
/* Neon Bonus Panel - Compact */
.neon-bonus-panel {
  background: rgba(10, 12, 18, 0.9) !important;
  border-radius: 12px;
  padding: 16px;
  color: #fff;
  border: 1px solid rgba(0, 224, 255, 0.15);
  box-shadow: 
    0 4px 12px rgba(0, 0, 0, 0.3),
    0 0 0 1px rgba(0, 224, 255, 0.05) inset;
}

.neon-bonus-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(0, 224, 255, 0.1);
}

.neon-glow-text {
  background: linear-gradient(90deg, #00ffff, #00b3ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
  margin: 0;
  font-size: 18px;
}

.neon-updated {
  font-size: 11px;
  color: #888;
  background: rgba(0, 0, 0, 0.3);
  padding: 3px 8px;
  border-radius: 10px;
}

.neon-bonus-cards {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}

.neon-bonus-card {
  background: rgba(16, 20, 30, 0.7);
  border-radius: 10px;
  padding: 14px;
  border: 1px solid rgba(255, 255, 255, 0.05);
  position: relative;
  overflow: hidden;
}

.neon-bonus-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  opacity: 0.6;
}

.neon-signup::before {
  background: linear-gradient(90deg, #ff00ff, #00ffff);
}

.neon-regular::before {
  background: linear-gradient(90deg, #00ff88, #00ccff);
}

.neon-claimed::before {
  background: linear-gradient(90deg, #666, #999);
}

.neon-bonus-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.neon-bonus-label {
  font-size: 12px;
  font-weight: 600;
  color: #a0a0a0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.neon-signup .neon-bonus-label {
  color: #ffffff !important;
}

.neon-bonus-badge {
  font-size: 12px;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.neon-signup .neon-eligible {
  color: #ffffff !important;
}

.neon-active {
  background: rgba(0, 255, 136, 0.15);
  color: #00ff88;
}

.neon-used {
  background: rgba(153, 153, 153, 0.15);
  color: #999;
}

.neon-bonus-percent {
  font-size: 24px;
  font-weight: 900;
  margin: 5px 0;
  letter-spacing: -0.5px;
}

.neon-signup .neon-bonus-percent {
  color: #ffffff !important;
  background: none !important;
  -webkit-background-clip: unset !important;
  -webkit-text-fill-color: unset !important;
}

.neon-regular .neon-bonus-percent {
  background: linear-gradient(90deg, #00ff88, #00ccff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.neon-claimed .neon-bonus-percent {
  color: #666;
}

.neon-bonus-max {
  font-size: 11px;
  color: #888;
  margin-bottom: 6px;
}

.neon-signup .neon-bonus-max {
  color: #ffffff !important;
}

.neon-bonus-status {
  font-size: 10px;
  font-weight: 800;
  padding: 4px 8px;
  border-radius: 20px;
  display: inline-block;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.neon-signup .neon-bonus-status {
  background: rgba(255, 255, 255, 0.15);
  color: #ffffff !important;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.neon-regular .neon-bonus-status {
  background: rgba(0, 255, 136, 0.1);
  color: #00ff88;
  border: 1px solid rgba(0, 255, 136, 0.2);
}

.neon-claimed .neon-bonus-status {
  background: rgba(102, 102, 102, 0.1);
  color: #666;
  border: 1px solid rgba(102, 102, 102, 0.2);
}

.neon-pulse {
  animation: neon-pulse 2s infinite;
}

@keyframes neon-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}
/* New styles for bonus info inside boxes */
.neon-bonus-info-inside {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid rgba(255, 255, 255, 0.07);
}
.neon-bonus-info-line {
  font-size: 10px;
  color: #aaa;
  line-height: 1.3;
  margin-bottom: 4px;
}

.neon-signup .neon-bonus-info-line {
  color: #ffffff; /* Changed to white */
}

.neon-regular .neon-bonus-info-line {
  color: rgba(0, 255, 136, 0.8);
}

.neon-bonus-auto-inside {
  font-size: 9px;
  color: #00ff88;
  margin-top: 4px;
  padding-top: 4px;
  border-top: 1px solid rgba(0, 255, 136, 0.1);
}

.neon-signup .neon-bonus-auto-inside {
  color: #ffffff !important;
  border-top: 1px solid rgba(255, 255, 255, 0.2);
}

/* Adjust card padding for the extra content */
.neon-bonus-card {
  padding-bottom: 16px; /* Increased from 14px */
}

/* Adjust spacing for mobile */
@media (max-width: 768px) {
  .neon-bonus-info-inside {
    margin-top: 10px;
    padding-top: 10px;
  }
  
  .neon-bonus-info-line {
    font-size: 9px;
  }
  
  .neon-bonus-auto-inside {
    font-size: 8px;
  }
}

/* Force all text in sign-up box to be white */
.neon-signup .neon-bonus-label,
.neon-signup .neon-bonus-percent,
.neon-signup .neon-bonus-max,
.neon-signup .neon-bonus-status,
.neon-signup .neon-bonus-auto-inside,
.neon-signup .neon-eligible {
  color: #ffffff !important;
}

/* Remove gradient from sign-up percentage */
.neon-signup .neon-bonus-percent {
  background: none !important;
  -webkit-background-clip: unset !important;
  -webkit-text-fill-color: unset !important;
}

/* Update sign-up badge styling */
.neon-signup .neon-eligible {
  background: rgba(255, 255, 255, 0.2);
}

/* Update sign-up status styling */
.neon-signup .neon-bonus-status {
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.3);
}

/* Mobile responsive */
@media (max-width: 768px) {
  .neon-bonus-panel {
    padding: 14px;
  }
  
  .neon-bonus-cards {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  .neon-bonus-percent {
    font-size: 22px;
  }
  
  .neon-glow-text {
    font-size: 16px;
  }
}
</style>
{% endif %}

    <div class="panel">
      <div class="panel-head">
        <div class="h3">Games</div>
      </div>

      <div class="game-grid">
        {% for g in games %}
          <article class="game-card">
            <div class="game-media">
              {% if g.icon_url %}
                <img src="{{ g.icon_url }}" alt="{{ g.name }}">
              {% else %}
                <div class="media-fallback">üéÆ</div>
              {% endif %}

              {# ---- Credits pill (uses gv_balances from app.py) ---- #}
              {% set bal = (gv_balances.get(g.id, 0) if gv_balances is defined else 0) | int %}
              {% set show_for_this_game = True %}
              {% if current_user.is_authenticated and show_for_this_game and bal > 0 %}
                <div class="gv-balance-pill" aria-label="Game credits">
                  Credits: {{ bal }}
                </div>
              {% endif %}
            </div>

            <div class="game-body">
              <div class="game-title" title="{{ g.name }}">{{ g.name }}</div>
              <div class="game-sub" title="{{ g.description or '' }}">{{ g.description or "Hottest game on the market" }}</div>
            </div>

            <div class="game-actions">
              {% if g.download_url %}
                <a class="btn btn-mini" target="_blank" href="{{ g.download_url }}">Download</a>
              {% else %}
                <button class="btn btn-mini" disabled>Download</button>
              {% endif %}

              {% if current_user.is_authenticated %}
                {# üîπ does this user have a login for this game? #}
                {% set has_login = (game_login_ids is defined and (g.id in game_login_ids)) %}

                {% if has_login %}
                  {# normal behavior if login exists #}
                  <a class="btn btn-mini"
                     href="{{ url_for('playerbp.deposit_step1') }}?game_id={{ g.id }}">
                    Deposit
                  </a>
                  <a class="btn btn-mini"
                     href="{{ url_for('playerbp.withdraw_get') }}?game_id={{ g.id }}">
                    Withdraw
                  </a>
                {% else %}
                  {# keep clickable, but intercept in JS and show notice #}
                  <a class="btn btn-mini js-need-login"
                     href="{{ url_for('playerbp.deposit_step1') }}?game_id={{ g.id }}"
                     data-game-name="{{ g.name }}">
                    Deposit
                  </a>
                  <a class="btn btn-mini js-need-login"
                     href="{{ url_for('playerbp.withdraw_get') }}?game_id={{ g.id }}"
                     data-game-name="{{ g.name }}">
                    Withdraw
                  </a>
                {% endif %}

                {# Request ID ‚Äì if login exists, show info popup, else start automation #}
                {% if has_login %}
                  <button
                    class="btn btn-mini btn-primary js-has-login"
                    type="button"
                    data-game-name="{{ g.name }}"
                  >
                    Request ID
                  </button>
                {% else %}
                  <form
                    method="post"
                    action="{{ url_for('playerbp.request_game_account', game_id=g.id) }}"
                    data-request-id-form
                    data-game-id="{{ g.id }}"
                    data-game-name="{{ g.name }}"
                  >
                    {% if csrf_token is defined %}
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% endif %}
                    <button class="btn btn-mini btn-primary" type="submit" data-request-btn>
                      Request ID
                    </button>
                  </form>
                {% endif %}
              {% else %}
                <a class="btn btn-mini" href="{{ url_for('auth.login_get') }}">Deposit</a>
                <a class="btn btn-mini" href="{{ url_for('auth.login_get') }}">Withdraw</a>
                <a class="btn btn-mini btn-primary" href="{{ url_for('auth.register_get') }}">Request ID</a>
              {% endif %}
            </div>

            {# overlay specific to THIS game card #}
            <div class="gc-card-loading" data-loading-overlay>
              <div class="gc-spinner" aria-hidden="true"></div>
              <div>Please wait, your ID is being processed...</div>
            </div>
          </article>
        {% else %}
          <div class="muted">No games available yet. Please check back soon.</div>
        {% endfor %}
      </div>
    </div>

    {# ===== MOBILE ONLY: Contact Us + Referral BELOW the game list ===== #}
    {% if not is_telegram %}
    <div class="show-mobile" style="display:none">
      <div class="panel" id="contact-mobile">
        <div class="rail-title">Contact Us</div>
        {% set wa = (settings.whatsapp_url if settings and settings.whatsapp_url else 'https://wa.me/+12342795662') %}
        {% set tg = (settings.telegram_url if settings and settings.telegram_url else 'https://t.me/Neonspire') %}
        {% set fb = (settings.facebook_url if settings and settings.facebook_url else 'https://www.facebook.com/neonspirecas') %}
        {% set ig = (settings.instagram_url if settings and settings.instagram_url else 'https://instagram.com/neonspirecasino') %}
        <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <a class="btn btn-mini btn-wide" href="{{ wa }}" target="_blank" rel="noopener noreferrer" data-external="1">WhatsApp</a>
          <a class="btn btn-mini btn-wide" href="{{ tg }}" target="_blank" rel="noopener noreferrer" data-external="1">Telegram</a>
          <a class="btn btn-mini btn-wide" href="{{ fb }}" target="_blank" rel="noopener noreferrer" data-external="1">Facebook</a>
          <a class="btn btn-mini btn-wide" href="{{ ig }}" target="_blank" rel="noopener noreferrer" data-external="1">Instagram</a>
        </div>
        <div class="muted" style="margin-top:8px">We're available 24/7.</div>
      </div>

      {% if current_user.is_authenticated and ((current_user.role or '')|upper == 'PLAYER') %}
      <div class="panel">
        <div class="rail-title">Referral Program</div>
        <button type="button" class="btn btn-wide js-ref-btn">Get My Link</button>
      </div>
      {% endif %}
    </div>
    {% endif %}

  </section>
</div>

{# ---- External link fail-safe ---- #}
<script>
document.addEventListener('DOMContentLoaded', function () {
  function isExternal(href) {
    try { const u = new URL(href, window.location.href); return u.origin !== window.location.origin; }
    catch { return false; }
  }
  document.querySelectorAll('a[data-external], a[target="_blank"]').forEach(function (a) {
    if (!isExternal(a.href)) return;
    a.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopImmediatePropagation();
      try { window.open(a.href, '_blank', 'noopener'); }
      catch (_) { window.location.href = a.href; }
      return false;
    }, { capture: true });
  });
});
</script>

{# ============================ BONUS FUNCTIONS ============================ #}
<script>
// Bonus-related JavaScript functions
function showBonusInstructions(bonusType) {
  const signupBonus = {{ bonus_settings.signup_percentage if bonus_settings else 100 }};
  const regularBonus = {{ bonus_settings.regular_percentage if bonus_settings else 50 }};
  const signupMin = {{ bonus_settings.signup_min_deposit if bonus_settings else 20.0 }};
  const regularMin = {{ bonus_settings.regular_min_deposit if bonus_settings else 10.0 }};
  const playerDepositCount = {{ current_user.deposit_count if current_user.is_authenticated else 0 }};
  const signupClaimed = {{ current_user.signup_bonus_claimed if current_user.is_authenticated else false }};
  
  let message = '';
  let title = '';
  
  if (bonusType === 'signup') {
      if (signupClaimed) {
          message = `You have already claimed your sign-up bonus. Next deposit will receive the regular bonus of ${regularBonus}%.`;
          title = 'Sign-Up Bonus Claimed';
      } else if (playerDepositCount > 0) {
          message = `You've already made deposits. Sign-up bonus can only be claimed on your first deposit.`;
          title = 'Not Eligible';
      } else {
          message = `To claim your ${signupBonus}% sign-up bonus:\n\n1. Make your first deposit (min: $${signupMin.toFixed(2)})\n2. Bonus will be automatically applied when staff approves your deposit\n3. One-time only - cannot be claimed again`;
          title = 'How to Claim Sign-Up Bonus';
      }
  } else {
      message = `Regular ${regularBonus}% bonus:\n\n‚Ä¢ Applied automatically on every deposit (min: $${regularMin.toFixed(2)})\n‚Ä¢ Max bonus: ${{ "%.2f"|format(bonus_settings.regular_max_amount if bonus_settings else 50.0) }}\n‚Ä¢ Bonus added when staff approves your deposit\n‚Ä¢ No limit on number of times`;
      title = 'Regular Bonus Information';
  }
  
  const modal = document.createElement('div');
  modal.style.cssText = `
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.7);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10000;
  `;
  
  const content = document.createElement('div');
  content.style.cssText = `
      background:#1a1f2e;
      border-radius:12px;
      padding:24px;
      max-width:400px;
      width:90%;
      border:1px solid rgba(255,255,255,0.1);
      color:#f9fafb;
  `;
  
  content.innerHTML = `
      <h3 style="margin:0 0 16px; color:#4fd1c7;">${title}</h3>
      <div style="white-space:pre-line; line-height:1.6; margin-bottom:20px;">${message}</div>
      <div style="display:flex; gap:10px;">
          <button onclick="this.parentElement.parentElement.parentElement.remove()" style="flex:1;" class="btn btn-primary">Close</button>
          ${bonusType === 'signup' && !signupClaimed && playerDepositCount === 0 ? 
              `<a href="{{ url_for('playerbp.deposit_step1') }}" style="flex:1;" class="btn btn-success">Make First Deposit</a>` : ''}
      </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
  });
}

</script>

{# ============================ REFERRAL POPUP & JS (only for players) ============================ #}
{% if current_user.is_authenticated and ((current_user.role or '')|upper == 'PLAYER') %}
<div id="refModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="refTitle"
     style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;">
  <div data-ref-overlay
       style="position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:saturate(120%) blur(2px)"></div>

  <div class="panel" role="document"
       style="position:relative;max-width:640px;width:92%;border-radius:14px;box-shadow:0 18px 60px rgba(0,0,0,.35);z-index:1">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
      <div id="refTitle" class="h3">Your Referral Link</div>
      <button type="button" class="btn btn-ghost" id="refCloseBtn" aria-label="Close">‚úï</button>
    </div>

    <div id="refBody">
      <div id="refLoading" class="muted">Generating your link...</div>

      <div id="refResult" style="display:none">
        <div class="muted" style="margin:0 0 8px 0">
          Share this link. It includes your code <b id="refCodeText">-</b>.
        </div>

        <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center">
          <input id="refLinkInput" class="input" readonly value="">
          <button class="btn btn-primary" type="button" id="copyRefBtn">Copy</button>
        </div>

        <div style="display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap">
          <a id="openRefBtn" class="btn" href="#" target="_blank" rel="noopener">Open</a>
          <button class="btn btn-ghost" type="button" id="newRefBtn">Regenerate</button>
        </div>

        <div class="muted" style="margin-top:8px;font-size:12px">
            Refer your friends and family to get exciting bonus üéÅ
        </div>
      </div>

      <div id="refError" style="display:none;color:#ff8a8a">Couldn't get your link. Please try again.</div>
    </div>
  </div>
</div>

{# ========= NEW: Centered popup when game login is missing ========= #}
<div id="needLoginModal" aria-hidden="true"
     style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;
            background:rgba(0,0,0,.6);backdrop-filter:blur(4px);">
  <div style="background:#111827;color:#f9fafb;padding:22px 26px;border-radius:16px;max-width:420px;width:90%;
              text-align:center;box-shadow:0 20px 50px rgba(0,0,0,.6);">
    <h3 style="margin:0;font-size:18px;font-weight:700;">Game ID required</h3>
    <p id="nlText" style="margin:12px 0 18px;font-size:14px;line-height:1.5;opacity:.9;">
      You don't have an ID for this game yet.<br>
      Create it first via <b>Request ID</b>.
    </p>
    <button id="nlClose" type="button" class="btn btn-primary" style="min-width:120px;">Got it</button>
  </div>
</div>

{# ===== NEW: Account creation failed / maintenance popup ===== #}
<div id="idFailModal" aria-hidden="true"
     style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;
            background:rgba(0,0,0,.6);backdrop-filter:blur(4px);">
  <div style="background:#111827;color:#f9fafb;padding:22px 26px;border-radius:16px;max-width:420px;width:90%;
              text-align:center;box-shadow:0 20px 50px rgba(0,0,0,.6);">
    <h3 style="margin:0;font-size:18px;font-weight:700;">Account creation failed</h3>
    <p id="idFailText" style="margin:12px 0 18px;font-size:14px;line-height:1.5;opacity:.9;">
      <!-- Filled by JS -->
      The game system is under maintenance.<br>
      Try again later or contact support.
    </p>
    <button id="idFailClose" type="button" class="btn btn-primary" style="min-width:120px;">Got it</button>
  </div>
</div>

{# ========= NEW: Popup when another game ID is already processing ========= #}
<div id="idBusyModal"
     aria-hidden="true"
     style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;
            background:rgba(0,0,0,.6);backdrop-filter:blur(4px);">
  <div style="background:#020617;color:#f9fafb;padding:22px 26px;border-radius:18px;max-width:420px;width:90%;
              text-align:center;box-shadow:0 22px 60px rgba(0,0,0,.75);border:1px solid rgba(148,163,184,.35);">
    <h3 style="margin:0 0 10px;font-size:18px;font-weight:700;">ID already in progress</h3>
    <p style="margin:0 0 18px;font-size:14px;line-height:1.6;opacity:.9;">
      Your game ID request is still processing.<br>
      Let's finish that one before starting a new ID.
    </p>
    <button id="idBusyClose" type="button" class="btn btn-primary" style="min-width:130px;">
      Okay, got it
    </button>
  </div>
</div>

{# ========= NEW: Popup when player already has this game ID ========= #}
<div id="idHasModal"
     aria-hidden="true"
     style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;
            background:rgba(0,0,0,.6);backdrop-filter:blur(4px);">
  <div style="background:#020617;color:#f9fafb;padding:22px 26px;border-radius:18px;max-width:420px;width:90%;
              text-align:center;box-shadow:0 22px 60px rgba(0,0,0,.75);border:1px solid rgba(148,163,184,.35);">
    <h3 style="margin:0 0 10px;font-size:18px;font-weight:700;">ID already created</h3>
    <p id="idHasText" style="margin:0 0 18px;font-size:14px;line-height:1.6;opacity:.9;">
      <!-- Filled by JS -->
      You already have an ID for this game.<br>
      Please check <b>My Logins</b>.
    </p>
    <button id="idHasClose" type="button" class="btn btn-primary" style="min-width:130px;">
      OK
    </button>
  </div>
</div>

<script>
(function(){
  const modal   = document.getElementById('refModal');
  const triggers = document.querySelectorAll('.js-ref-btn');
  if(!modal || !triggers.length) return;

  const closeBtn   = document.getElementById('refCloseBtn');
  const overlay    = modal.querySelector('[data-ref-overlay]');
  const loadingEl  = document.getElementById('refLoading');
  const resultEl   = document.getElementById('refResult');
  const errorEl    = document.getElementById('refError');
  const inputEl    = document.getElementById('refLinkInput');
  const codeEl     = document.getElementById('refCodeText');
  const copyBtn    = document.getElementById('copyRefBtn');
  const openBtn    = document.getElementById('openRefBtn');
  const regenBtn   = document.getElementById('newRefBtn');

  function openModal(){ modal.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
  function closeModal(){ modal.style.display = 'none'; document.body.style.overflow = ''; }
  function setState(state){
    loadingEl.style.display = state==='loading' ? '' : 'none';
    resultEl.style.display  = state==='result'  ? '' : 'none';
    errorEl.style.display   = state==='error'   ? '' : 'none';
  }

  async function fetchRef(jsonUrl){
    setState('loading');
    try{
      const r = await fetch(jsonUrl, {credentials:'same-origin', headers:{'Accept':'application/json'}});
      if(!r.ok) throw new Error('bad response');
      const data = await r.json();
      inputEl.value = data.link || '';
      codeEl.textContent = data.code || '-';
      openBtn.href = data.link || '#';
      setState('result');
    }catch(e){ setState('error'); }
  }

  triggers.forEach(btn => {
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopPropagation();
      openModal();
      fetchRef("{{ url_for('playerbp.referral_my_link_json') }}");
    });
  });

  if(regenBtn){
    regenBtn.addEventListener('click', ()=>{ fetchRef("{{ url_for('playerbp.referral_my_link_json') }}?force=1"); });
  }

  copyBtn.addEventListener('click', async ()=>{
    try{
      inputEl.select(); inputEl.setSelectionRange(0, 99999);
      if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(inputEl.value); }
      else { document.execCommand('copy'); }
      copyBtn.textContent = 'Copied!'; setTimeout(()=>copyBtn.textContent='Copy', 1200);
    }catch(_){ alert('Copied!'); }
  });

  [closeBtn, overlay].forEach(el => el.addEventListener('click', closeModal));
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal.style.display === 'flex'){ closeModal(); } });
})();
</script>

<script>
  // Request ID flow:
  // 1) POST to request_game_account
  // 2) Show per-card overlay
  // 3) Get latest req_id for this game
  // 4) Poll queue status
  // 5) When APPROVED -> redirect to My Logins
  (function () {
    const forms = document.querySelectorAll('[data-request-id-form]');
    if (!forms.length) return;

    const toastEl     = document.getElementById('idToast');
    const toastTextEl = document.getElementById('idToastText');

    // Modal shown when another ID is already processing
    const busyModal = document.getElementById('idBusyModal');
    const busyClose = document.getElementById('idBusyClose');
    
    function showBusyModal() {
      if (!busyModal) return;
      busyModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    
    function hideBusyModal() {
      if (!busyModal) return;
      busyModal.style.display = 'none';
      document.body.style.overflow = '';
    }
    
    if (busyClose && busyModal) {
      busyClose.addEventListener('click', hideBusyModal);
      busyModal.addEventListener('click', function (e) {
        if (e.target === busyModal) hideBusyModal();
      });
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && busyModal.style.display === 'flex') {
          hideBusyModal();
        }
      });
    }

    // Try to auto-detect My Logins URL from any link that says "My Logins"
    const myLoginsUrl = (function () {
      const links = Array.from(document.querySelectorAll('a'));
      const match = links.find(a =>
        a.textContent && /my logins/i.test(a.textContent)
      );
      return match ? match.href : window.location.href;
    })();

    function showToast(msg) {
      if (!toastEl || !toastTextEl) return;
      toastTextEl.textContent = msg;
      toastEl.style.display = 'flex';
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => {
        toastEl.style.display = 'none';
      }, 2600);
    }

    // Track if any ID request is currently processing (global)
    let hasActiveRequest = window.neonHasActiveRequest || false;
    window.neonHasActiveRequest = hasActiveRequest;

    let pollTimer = null;
    let pollKill  = null;

    function startPolling(reqId, gameName, overlay) {
      const statusUrl     = `/player/request/${reqId}/status.json`;
      const POLL_INTERVAL = 5000;    // 5s
      const MAX_WAIT_MS   = 180000;  // 3 min safety

      if (pollTimer) clearInterval(pollTimer);
      if (pollKill)  clearTimeout(pollKill);

      pollTimer = setInterval(() => {
        fetch(statusUrl, { credentials: 'same-origin' })
          .then(r => r.json())
          .then(data => {
            if (!data || data.ok === false) return;

            const status  = (data.status || '').toUpperCase();
            const message = data.progress;

            if (overlay && message) {
              const msgEl = overlay.querySelector('div:not(.gc-spinner)');
              if (msgEl) msgEl.textContent = message;
            }

            if (status === 'APPROVED') {
              clearInterval(pollTimer);
              clearTimeout(pollKill);
              pollTimer = null;
              pollKill  = null;
              hasActiveRequest = false;
              window.neonHasActiveRequest = false;

              if (overlay) {
                overlay.style.display = 'flex';
                const msgEl = overlay.querySelector('div:not(.gc-spinner)');
                if (msgEl) {
                  msgEl.innerHTML =
                    `Your <b>${gameName}</b> login is ready!<br>` +
                    `Redirecting you to <b>My Logins</b>...`;
                }
              }

              showToast(`${gameName} login ready. Opening My Logins...`);
              setTimeout(() => { window.location.href = myLoginsUrl; }, 1500);
              } else if (status === 'FAILED') {
              clearInterval(pollTimer);
              clearTimeout(pollKill);
              pollTimer = null;
              pollKill  = null;
              hasActiveRequest = false;
              window.neonHasActiveRequest = false;

              if (overlay) overlay.style.display = 'none';

              // Show centered maintenance popup on lobby
              if (window.showIdFailPopup) {
                window.showIdFailPopup(gameName);
              } else {
                // Fallback toast if modal helper is missing
                showToast(`${gameName} server is under maintenance. Please try again later.`);
              }
            }
          })
          .catch(err => {
            console.error('status poll error:', err);
          });
      }, POLL_INTERVAL);

      // Safety: stop polling after MAX_WAIT_MS
      pollKill = setTimeout(() => {
        clearInterval(pollTimer);
        pollTimer = null;
        hasActiveRequest = false;
        window.neonHasActiveRequest = false;

        if (overlay) {
          const msgEl = overlay.querySelector('div:not(.gc-spinner)');
          if (msgEl) {
            msgEl.innerHTML =
              `Your <b>${gameName}</b> ID is still being created.<br>` +
              `You can always check it in <b>My Logins</b>.`;
          }
          setTimeout(() => { overlay.style.display = 'none'; }, 4000);
        }
      }, MAX_WAIT_MS);
    }

    forms.forEach(function (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();

        const gameName = form.dataset.gameName || 'this game';
        const gameId   = form.dataset.gameId;
        if (!gameId) {
          console.warn('Missing data-game-id on form');
          return;
        }

        // Prevent multiple parallel requests in one page
        if (hasActiveRequest) {
          showBusyModal();
          return;
        }
        hasActiveRequest = true;
        window.neonHasActiveRequest = true;

        const card    = form.closest('.game-card');
        const overlay = card ? card.querySelector('[data-loading-overlay]') : null;
        const btn     = form.querySelector('[data-request-btn]');

        if (overlay) {
          overlay.style.display = 'flex';
          const msgEl = overlay.querySelector('div:not(.gc-spinner)');
          if (msgEl) msgEl.textContent = `Creating your ${gameName} ID...`;
        }

        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Processing...';
        }

        // 1) Send POST to start request
        fetch(form.action, {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          body: new FormData(form),
        })
        .then(resp => {
          if (!resp.ok) throw new Error('Bad status: ' + resp.status);

          // 2) Ask backend for latest request id for this game
          return fetch(`/player/request/latest/${gameId}.json`, {
            credentials: 'same-origin',
            headers: { 'Accept': 'application/json' },
          });
        })
        .then(r => r.json())
        .then(data => {
          if (!data || data.ok === false || !data.request_id) {
            throw new Error((data && data.error) || 'No request id');
          }

          if (btn) btn.textContent = 'Requested';
          showToast(`${gameName} ID request submitted.`);

          // 3) Start polling this req_id
          startPolling(data.request_id, gameName, overlay);
        })
        .catch(err => {
          console.error('ID request error:', err);
          hasActiveRequest = false;
          window.neonHasActiveRequest = false;

          if (overlay) overlay.style.display = 'none';
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'Request ID';
          }

          showToast('Could not start request. Please try again.');
        });
      });
    });
  })();
</script>

<script>
  // üîπ Block deposit/withdraw when no game login exists, but keep buttons clickable
  (function () {
    const links = document.querySelectorAll('.js-need-login');
    if (!links.length) return;

    const modal = document.getElementById('needLoginModal');
    const text  = document.getElementById('nlText');
    const close = document.getElementById('nlClose');

    function openPopup(gameName) {
      text.innerHTML = `You don't have a <b>${gameName}</b> ID yet.<br>Create it first via <b>Request ID</b>.`;
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closePopup() {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }

    close.addEventListener('click', closePopup);
    modal.addEventListener('click', function(e){
      if (e.target === modal) {
        closePopup();
      }
    });
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        closePopup();
      }
    });

    links.forEach(link => {
      link.addEventListener('click', function (e) {
        e.preventDefault();
        const gameName = link.dataset.gameName || 'this game';
        openPopup(gameName);
      });
    });
  })();
</script>

<script>
  // üîπ Show popup when player already has this game ID
  (function () {
    const btns   = document.querySelectorAll('.js-has-login');
    if (!btns.length) return;

    const modal  = document.getElementById('idHasModal');
    const textEl = document.getElementById('idHasText');
    const close  = document.getElementById('idHasClose');

    if (!modal || !textEl || !close) return;

    // Detect "My Logins" URL (same trick as other script)
    const myLoginsUrl = (function () {
      const links = Array.from(document.querySelectorAll('a'));
      const match = links.find(a =>
        a.textContent && /my logins/i.test(a.textContent)
      );
      return match ? match.href : window.location.href;
    })();

    function openHasModal(gameName, duringActive) {
      const safeName = gameName || 'this game';

      if (duringActive) {
        // Text when another game ID is still processing
        textEl.innerHTML =
          `You already have a <b>${safeName}</b> ID.<br>` +
          `Finish your current request, then open <b>My Logins</b> to view your details.`;
      } else {
        // Normal text when no active request
        textEl.innerHTML =
          `You already have a <b>${safeName}</b> ID.<br>` +
          `Please check <b>My Logins</b> to view your username & password.`;
      }

      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeHasModal() {
      modal.style.display = 'none';
      document.body.style.overflow = '';
      // No redirect here ‚Äì let the current game request finish.
    }

    close.addEventListener('click', closeHasModal);
    modal.addEventListener('click', function (e) {
      if (e.target === modal) {
        closeHasModal();
      }
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        closeHasModal();
      }
    });

    btns.forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const gameName = btn.dataset.gameName || 'this game';

        // üîπ Check if some other game ID is processing (set in Request ID flow)
        const active = !!window.neonHasActiveRequest;

        openHasModal(gameName, active);
      });
    });
  })();
</script>

<script>
  // üîπ Global helper: show popup when account creation FAILS (Celery / automation error)
  (function () {
    const modal = document.getElementById('idFailModal');
    const text  = document.getElementById('idFailText');
    const close = document.getElementById('idFailClose');
    if (!modal || !text || !close) return;

    function openFailPopup(gameName) {
      const safeName = gameName || 'this game';
      text.innerHTML = `${safeName} system is under maintenance.<br>Try again later or contact support.`;
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeFailPopup() {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }

    close.addEventListener('click', closeFailPopup);
    modal.addEventListener('click', function (e) {
      if (e.target === modal) {
        closeFailPopup();
      }
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        closeFailPopup();
      }
    });

    // Make available globally so other scripts can call it when status === "FAILED"
    window.showIdFailPopup = openFailPopup;
  })();
</script>

<!-- Bonus Countdown Timer Script -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const bonusTimer = document.getElementById('bonusTimer');
    const countdownEl = document.getElementById('bonusCountdown');
    
    if (bonusTimer && countdownEl) {
      // This is a placeholder - in real implementation, you would get the expiration time from your backend
      // For now, we'll simulate a 24-hour countdown
      let hours = 24;
      let minutes = 0;
      let seconds = 0;
      
      function updateCountdown() {
        seconds--;
        if (seconds < 0) {
          seconds = 59;
          minutes--;
          if (minutes < 0) {
            minutes = 59;
            hours--;
            if (hours < 0) {
              clearInterval(countdownInterval);
              bonusTimer.textContent = 'Bonus expired';
              return;
            }
          }
        }
        
        countdownEl.textContent = `${hours}h ${minutes}m ${seconds}s`;
      }
      
      // Start countdown
      const countdownInterval = setInterval(updateCountdown, 1000);
      updateCountdown(); // Initial call
    }
  });
</script>

{% endif %}
{% endblock %}