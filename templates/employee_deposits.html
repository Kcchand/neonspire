{% extends "base.html" %}
{% block content %}

<style>
  /* Subtle table polish + right-aligned actions */
  .tbl { width:100%; border-collapse:separate; border-spacing:0; }
  .tbl th, .tbl td { padding:10px 12px; vertical-align:middle; }
  .tbl thead th { text-align:left; font-weight:700; opacity:.9; }
  .tbl td.actions { text-align:right; white-space:nowrap; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .muted-wrap { display:flex; flex-direction:column; gap:2px; }
  .cred { display:flex; gap:8px; align-items:center; }
  .cred .pill { padding:2px 8px; border-radius:8px; border:1px solid var(--stroke); font-size:12px; }
  .icon-btn { border:1px solid var(--stroke); border-radius:8px; background:transparent; padding:6px 8px; cursor:pointer; }
  .icon-btn[disabled] { opacity:.5; cursor:not-allowed; }
  .between { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .inline-form { display:flex; align-items:center; gap:8px; }
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt24{margin-top:24px}
  .row.gap8 { display:flex; gap:8px; align-items:center; justify-content:flex-end; }
  .w-compact { width:1%; white-space:nowrap; }
</style>

<div class="card card-glass">
  <div class="between">
    <h1 class="h1">Deposits</h1>

    <form method="get" class="inline-form">
      <select name="status" class="input">
        {% for st in ['PENDING','RECEIVED','LOADED','REJECTED'] %}
          <option value="{{ st }}" {% if status==st %}selected{% endif %}>{{ st }}</option>
        {% endfor %}
      </select>
      <input class="input" name="q" placeholder="Search noteâ€¦" value="{{ q or '' }}" />
      <button class="btn btn-ghost" type="submit">Filter</button>
    </form>
  </div>

  {% set bonus = (settings.bonus_percent if settings else 0) %}

  {# =================== NEW ENHANCED RENDER (uses pending_rows / recent_rows) =================== #}
  {% if pending_rows is defined or recent_rows is defined %}
    <h3 class="h3 mt16">Pending</h3>
    <table class="tbl mt8">
      <thead>
        <tr>
          <th class="w-compact">ID</th>
          <th>User</th>
          <th>Game</th>
          <th>Login</th>
          <th>Amount</th>
          <th>Method</th>
          <th>Created</th>
          <th class="actions w-compact">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for r in pending_rows or [] %}
          {% set d = r.dep %}
          <tr>
            <td class="mono">#{{ d.id }}</td>
            <td>
              <div class="muted-wrap">
                <strong>{{ r.user_name }}</strong>
                {% if refcodes and refcodes.get(d.user_id) %}
                  <span class="muted">Ref: {{ refcodes.get(d.user_id) }}</span>
                {% endif %}
              </div>
            </td>
            <td>{{ r.game_name }}</td>
            <td>
              {% if r.login_user or r.login_pass or r.login_note %}
                <div class="cred">
                  {% if r.login_user %}
                    <span class="pill mono" title="Username">{{ r.login_user }}</span>
                    <button class="icon-btn" type="button" data-copy="{{ r.login_user }}" title="Copy username">ðŸ“‹</button>
                  {% endif %}
                </div>
                <div class="cred" style="margin-top:4px">
                  {% if r.login_pass %}
                    <span class="pill mono" title="Password">{{ r.login_pass }}</span>
                    <button class="icon-btn" type="button" data-copy="{{ r.login_pass }}" title="Copy password">ðŸ“‹</button>
                  {% endif %}
                </div>
                {% if r.login_note %}
                  <div class="muted mono" style="margin-top:4px">{{ r.login_note }}</div>
                {% endif %}
              {% else %}
                <span class="muted">No credentials on file</span>
              {% endif %}
            </td>
            <td>{{ d.amount }}</td>
            <td>{{ d.method }}</td>
            <td class="mono">{{ d.created_at.strftime('%Y-%m-%d %H:%M') if d.created_at }}</td>
            <td class="actions">
              <div class="row gap8">
                <a class="btn btn-ghost" href="{{ url_for('employeebp.deposit_detail', dep_id=d.id) }}">Details</a>
                <form method="post" action="{{ url_for('employeebp.deposits_loaded', dep_id=d.id) }}">
                  <button class="btn btn-primary">Approve & Load (+{{ bonus or 0 }}%)</button>
                </form>
                <form method="post" action="{{ url_for('employeebp.deposits_reject', dep_id=d.id) }}">
                  <button class="btn btn-ghost">Reject</button>
                </form>
              </div>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="8" class="muted">No pending deposits.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <h3 class="h3 mt24">Recent</h3>
    <table class="tbl mt8">
      <thead>
        <tr>
          <th class="w-compact">ID</th>
          <th>User</th>
          <th>Game</th>
          <th>Login</th>
          <th>Amount</th>
          <th>Method</th>
          <th>Status</th>
          <th>Updated</th>
          <th class="actions w-compact">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for r in recent_rows or [] %}
          {% set d = r.dep %}
          <tr>
            <td class="mono">#{{ d.id }}</td>
            <td>
              <div class="muted-wrap">
                <strong>{{ r.user_name }}</strong>
                {% if refcodes and refcodes.get(d.user_id) %}
                  <span class="muted">Ref: {{ refcodes.get(d.user_id) }}</span>
                {% endif %}
              </div>
            </td>
            <td>{{ r.game_name }}</td>
            <td>
              {% if r.login_user or r.login_pass or r.login_note %}
                <div class="cred">
                  {% if r.login_user %}
                    <span class="pill mono" title="Username">{{ r.login_user }}</span>
                    <button class="icon-btn" type="button" data-copy="{{ r.login_user }}" title="Copy username">ðŸ“‹</button>
                  {% endif %}
                </div>
                <div class="cred" style="margin-top:4px">
                  {% if r.login_pass %}
                    <span class="pill mono" title="Password">{{ r.login_pass }}</span>
                    <button class="icon-btn" type="button" data-copy="{{ r.login_pass }}" title="Copy password">ðŸ“‹</button>
                  {% endif %}
                </div>
                {% if r.login_note %}
                  <div class="muted mono" style="margin-top:4px">{{ r.login_note }}</div>
                {% endif %}
              {% else %}
                <span class="muted">No credentials on file</span>
              {% endif %}
            </td>
            <td>{{ d.amount }}</td>
            <td>{{ d.method }}</td>
            <td>{{ d.status }}</td>
            <td class="mono">{{ (d.updated_at or d.created_at).strftime('%Y-%m-%d %H:%M') if (d.updated_at or d.created_at) }}</td>
            <td class="actions">
              <div class="row gap8">
                <a class="btn btn-ghost" href="{{ url_for('employeebp.deposit_detail', dep_id=d.id) }}">Details</a>
                <form method="post" action="{{ url_for('employeebp.deposits_loaded', dep_id=d.id) }}">
                  <button class="btn btn-primary" {% if d.status not in ['PENDING','RECEIVED'] %}disabled{% endif %}>
                    Approve & Load (+{{ bonus or 0 }}%)
                  </button>
                </form>
                <form method="post" action="{{ url_for('employeebp.deposits_reject', dep_id=d.id) }}">
                  <button class="btn btn-ghost" {% if d.status in ['LOADED','REJECTED'] %}disabled{% endif %}>Reject</button>
                </form>
              </div>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="9" class="muted">No recent items.</td></tr>
        {% endfor %}
      </tbody>
    </table>

  {# =================== LEGACY RENDER (uses your original context) =================== #}
  {% elif items is defined %}
    <table class="tbl mt12">
      <thead>
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Amount</th>
          <th>Method</th>
          <th>Status</th>
          <th>Updated</th>
          <th class="actions">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for d in items %}
          {% set u = (users.get(d.user_id) if users is defined else None) %}
          {% set code = (refcodes.get(d.user_id) if refcodes is defined else None) %}
          <tr>
            <td class="mono">#{{ d.id }}</td>
            <td>
              {{ (u.name if u and u.name else (u.email if u else 'User #' ~ d.user_id)) }}
              {% if code %}<div class="muted">Ref: {{ code }}</div>{% endif %}
            </td>
            <td>{{ d.amount }}</td>
            <td>{{ d.method }}</td>
            <td>{{ d.status }}</td>
            <td class="mono">{{ (d.updated_at or d.created_at).strftime('%Y-%m-%d %H:%M') }}</td>
            <td class="actions">
              <div class="row gap8">
                <a class="btn btn-ghost" href="{{ url_for('employeebp.deposit_detail', dep_id=d.id) }}">Details</a>
                <form method="post" action="{{ url_for('employeebp.deposits_loaded', dep_id=d.id) }}">
                  <button class="btn btn-primary" {% if d.status not in ['PENDING','RECEIVED'] %}disabled{% endif %}>
                    Approve & Load (+{{ bonus or 0 }}%)
                  </button>
                </form>
                <form method="post" action="{{ url_for('employeebp.deposits_reject', dep_id=d.id) }}">
                  <button class="btn btn-ghost" {% if d.status in ['LOADED','REJECTED'] %}disabled{% endif %}>Reject</button>
                </form>
              </div>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="7" class="muted">No items.</td></tr>
        {% endfor %}
      </tbody>
    </table>

  {% else %}
    <h3 class="h3 mt16">Pending</h3>
    <table class="tbl mt8">
      <thead>
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Amount</th>
          <th>Method</th>
          <th>Created</th>
          <th class="actions">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for d in pending %}
          {% set u = (users.get(d.user_id) if users is defined else None) %}
          {% set code = (refcodes.get(d.user_id) if refcodes is defined else None) %}
          <tr>
            <td class="mono">#{{ d.id }}</td>
            <td>
              {{ (u.name if u and u.name else (u.email if u else 'User #' ~ d.user_id)) }}
              {% if code %}<div class="muted">Ref: {{ code }}</div>{% endif %}
            </td>
            <td>{{ d.amount }}</td>
            <td>{{ d.method }}</td>
            <td class="mono">{{ (d.created_at).strftime('%Y-%m-%d %H:%M') }}</td>
            <td class="actions">
              <div class="row gap8">
                <a class="btn btn-ghost" href="{{ url_for('employeebp.deposit_detail', dep_id=d.id) }}">Details</a>
                <form method="post" action="{{ url_for('employeebp.deposits_loaded', dep_id=d.id) }}">
                  <button class="btn btn-primary">Approve & Load (+{{ bonus or 0 }}%)</button>
                </form>
                <form method="post" action="{{ url_for('employeebp.deposits_reject', dep_id=d.id) }}">
                  <button class="btn btn-ghost">Reject</button>
                </form>
              </div>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="6" class="muted">No pending deposits.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <h3 class="h3 mt24">Recent</h3>
    <table class="tbl mt8">
      <thead>
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Amount</th>
          <th>Method</th>
          <th>Status</th>
          <th>Updated</th>
          <th class="actions">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for d in recent %}
          {% set u = (users.get(d.user_id) if users is defined else None) %}
          {% set code = (refcodes.get(d.user_id) if refcodes is defined else None) %}
          <tr>
            <td class="mono">#{{ d.id }}</td>
            <td>
              {{ (u.name if u and u.name else (u.email if u else 'User #' ~ d.user_id)) }}
              {% if code %}<div class="muted">Ref: {{ code }}</div>{% endif %}
            </td>
            <td>{{ d.amount }}</td>
            <td>{{ d.method }}</td>
            <td>{{ d.status }}</td>
            <td class="mono">{{ (d.updated_at or d.created_at).strftime('%Y-%m-%d %H:%M') }}</td>
            <td class="actions">
              <div class="row gap8">
                <a class="btn btn-ghost" href="{{ url_for('employeebp.deposit_detail', dep_id=d.id) }}">Details</a>
                <form method="post" action="{{ url_for('employeebp.deposits_loaded', dep_id=d.id) }}">
                  <button class="btn btn-primary" {% if d.status not in ['PENDING','RECEIVED'] %}disabled{% endif %}>
                    Approve & Load (+{{ bonus or 0 }}%)
                  </button>
                </form>
                <form method="post" action="{{ url_for('employeebp.deposits_reject', dep_id=d.id) }}">
                  <button class="btn btn-ghost" {% if d.status in ['LOADED','REJECTED'] %}disabled{% endif %}>Reject</button>
                </form>
              </div>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="7" class="muted">No recent items.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>

<script>
  // Simple copy-to-clipboard for credential pills
  document.addEventListener('click', function(e){
    const btn = e.target.closest('[data-copy]');
    if(!btn) return;
    const txt = btn.getAttribute('data-copy') || '';
    if(!txt) return;
    navigator.clipboard.writeText(txt).then(()=>{
      btn.textContent = 'âœ…';
      setTimeout(()=>btn.textContent='ðŸ“‹', 900);
    }).catch(()=>{ /* ignore */ });
  });
</script>

{% endblock %}