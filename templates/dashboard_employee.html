{% extends "base.html" %}

{% block content %}
<div class="shell admin-wrap" style="margin-top:14px">

  <!-- Header -->
  <div class="panel">
    <div class="admin-head" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div class="admin-title">Employee Console</div>
      <div class="admin-actions" style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn chip-btn" href="{{ url_for('employeebp.deposits_list') }}">Deposits</a>
        <a class="btn chip-btn" href="{{ url_for('employeebp.requests_list') }}">Game Requests</a>
        <!-- FIXED: removed broken ready_accounts_page -->
        <!-- <a class="btn chip-btn" href="{{ url_for('employeebp.ready_accounts_page') }}">Ready Accounts</a> -->
        <a class="btn chip-btn" href="{{ url_for('employeebp.withdrawals_list') }}">Withdrawals</a>
        <a class="btn chip-btn btn-primary" href="{{ url_for('chat_bp.inbox') }}">Live Chat</a>
      </div>
    </div>
    <div class="muted">
      Process player deposits, approve/reject game login requests, pay withdrawals, and chat with players directly.
    </div>
  </div>

  <!-- Metrics -->
  <div class="admin-metrics" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
    <div class="metric panel" style="padding:14px">
      <div class="metric-label muted">Pending Deposits</div>
      <div class="metric-value" style="font-size:28px;font-weight:800;line-height:1.2">{{ pending_deposits or 0 }}</div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn btn-mini btn-primary" href="{{ url_for('employeebp.deposits_list') }}">Review Deposits</a>
      </div>
    </div>

    <div class="metric panel" style="padding:14px">
      <div class="metric-label muted">Pending Game Requests</div>
      <div class="metric-value" style="font-size:28px;font-weight:800;line-height:1.2">{{ pending_requests or 0 }}</div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn btn-mini" href="{{ url_for('employeebp.requests_list') }}">Provide Logins</a>
      </div>
      <div class="muted" style="margin-top:6px;font-size:12px">
        Tip: Open a request with <b>Provide Logins</b>. Inside the card you‚Äôll find <b>Save</b>, <b>Approve</b>, and <b>Reject</b>.
      </div>
    </div>

    <div class="metric panel" style="padding:14px">
      <div class="metric-label muted">Pending Withdrawals</div>
      <div class="metric-value" style="font-size:28px;font-weight:800;line-height:1.2">{{ pending_withdraws or 0 }}</div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn btn-mini" href="{{ url_for('employeebp.withdrawals_list') }}">Pay Out</a>
      </div>
    </div>

    <div class="metric panel" style="padding:14px">
      <div class="metric-label muted">Live Chat</div>
      <div class="metric-value" style="font-size:16px;font-weight:800;line-height:1.2">Support</div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn btn-mini btn-primary" href="{{ url_for('chat_bp.inbox') }}">Open Chat Inbox</a>
      </div>
      <div class="muted" style="margin-top:6px;font-size:12px">
        See who messaged you (with full player name &amp; email) and reply in a private thread.
      </div>
    </div>
  </div>

  <!-- Work Queues Shortcuts -->
  <div class="panel" style="margin-top:12px">
    <div class="section-head" style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
      <div class="section-title">Work Queues</div>
    </div>
    <div class="chip-row" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">
      <a class="chip" href="{{ url_for('employeebp.deposits_list') }}">üí≥ Review Deposits</a>
      <a class="chip" href="{{ url_for('employeebp.requests_list') }}">üîê Provide Game Logins</a>
      <a class="chip" href="{{ url_for('employeebp.withdrawals_list') }}">üí∏ Handle Withdrawals</a>
      <a class="chip" href="{{ url_for('chat_bp.inbox') }}">üí¨ Live Chat Inbox</a>
    </div>
  </div>

  <!-- Players Information (searchable + scrollable) -->
  <div class="panel" style="margin-top:12px" id="playersPanel">
    <div class="section-head" style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
      <div class="section-title">Players</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="playersSearch" class="input" placeholder="Search name / email / phone / referral‚Ä¶" style="min-width:260px">
        <div class="muted" id="playersCount">
          {% set total = (players|length if players else 0) %}
          Showing <b>{{ total }}</b> of <b>{{ total }}</b>
        </div>
      </div>
    </div>

    {% if players and players|length %}
      <style>
        #playersScrollWrap{ max-height:420px; overflow:auto; border-radius:14px; }
        #playersTable .t-head{
          position:sticky; top:0; z-index:1;
          background: rgba(18,20,25,.98);
          backdrop-filter: blur(6px);
          border-bottom: 1px solid var(--stroke, #2a2e37);
        }
        #playersTable .t-row{ transition: background .12s ease; }
        #playersTable .t-row:hover{ background: rgba(255,255,255,.03); }
        .badge{ display:inline-flex; align-items:center; justify-content:center; min-width:1.6em; padding:0 .4em; border-radius:999px; background:rgba(255,255,255,.08) }
        .refcode{ user-select: all; }
        @media (max-width:900px){ #playersScrollWrap{ max-height:60vh; } }
      </style>

      <div id="playersScrollWrap">
        <div class="table" id="playersTable">
          <div class="t-head">
            <div>Player</div>
            <div>Contact</div>
            <div>Referral</div>
            <div class="t-right">Games</div>
            <div>Last Request</div>
            <div>Joined</div>
          </div>

          {% for p in players %}
            {% set search_text = (p.name or '') ~ ' ' ~ (p.email or '') ~ ' ' ~ (p.mobile or '') ~ ' ' ~ (p.refcode or '') ~ ' ' ~ (p.last_game or '') %}
            <div class="t-row" data-search="{{ search_text|lower }}">
              <!-- Player -->
              <div>
                <div style="font-weight:700">{{ p.name or ('User #' ~ p.id) }}</div>
                <div class="muted" style="font-size:12px">{{ p.email }}</div>
              </div>

              <!-- Contact -->
              <div>
                {% if p.mobile %}
                  <span class="mono">{{ p.mobile }}</span>
                {% else %}
                  <span class="muted">‚Äî</span>
                {% endif %}
              </div>

              <!-- Referral -->
              <div>
                {% if p.refcode %}
                  <code class="mono refcode" title="Click-drag to copy">{{ p.refcode }}</code>
                {% else %}
                  <span class="muted">‚Äî</span>
                {% endif %}
              </div>

              <!-- Games count -->
              <div class="t-right">
                <span class="badge">{{ p.games_count or 0 }}</span>
              </div>

              <!-- Last Requested Game -->
              <div>
                {% if p.last_game and p.last_game_id %}
                  <a class="link" href="{{ url_for('employeebp.requests_list_by_game', game_id=p.last_game_id) }}">{{ p.last_game }}</a>
                {% else %}
                  <span class="muted">‚Äî</span>
                {% endif %}
              </div>

              <!-- Joined -->
              <div class="mono">
                {% if p.joined %}{{ p.joined.strftime('%Y-%m-%d %H:%M') }}{% else %}‚Äî{% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <script>
        (function(){
          const input   = document.getElementById('playersSearch');
          const rows    = Array.from(document.querySelectorAll('#playersTable .t-row'));
          const counter = document.getElementById('playersCount');
          function update(){
            const q = (input.value || '').trim().toLowerCase();
            let shown = 0;
            for(const r of rows){
              const hay = r.dataset.search || '';
              const hit = !q || hay.includes(q);
              r.style.display = hit ? '' : 'none';
              if(hit) shown++;
            }
            counter.innerHTML = `Showing <b>${shown}</b> of <b>${rows.length}</b>`;
          }
          input.addEventListener('input', update);
          input.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ input.value=''; update(); }});
          update();
        })();
      </script>
    {% else %}
      <div class="empty">No players yet.</div>
    {% endif %}
  </div>

</div>
{% endblock %}