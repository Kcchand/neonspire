{% extends "base.html" %}
{% block content %}
<div class="shell">

  <div class="panel" style="margin-bottom:14px">
    <div class="panel-head" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div class="h3">Withdrawals</div>
      <div class="muted">
        Pending: <strong>{{ pending|length }}</strong> • Recent: <strong>{{ recent|length }}</strong>
      </div>
    </div>
  </div>

  {# ----------------------- PENDING ----------------------- #}
  <div class="panel">
    <div class="h4" style="margin-bottom:10px">Pending</div>

    {% if pending %}
      <div class="table">
        <div class="t-head">
          <div>ID</div>
          <div>Player</div>
          <div>Game</div>
          <div>Method</div>
          <div>Destination</div>
          <div>Amount</div>
          <div>Wallet</div>
          <div>Requested</div>
          <div>Actions</div>
        </div>

        {% for w in pending %}
          {% set user = users.get(w.user_id) %}
          {% set game = games.get(w.game_id) %}
          {% set wallet = wallets.get(w.user_id) %}
          <div class="t-row">
            <div class="mono">#{{ w.id }}</div>

            <div>
              <div class="strong">{{ (user.name or user.email) if user else ('User #' ~ w.user_id) }}</div>
              {% if user and user.email %}
                <div class="muted mono" style="font-size:12px">{{ user.email }}</div>
              {% endif %}
            </div>

            <div>{{ game.name if game else '—' }}</div>

            <div>
              <span class="badge">{{ (w.method or 'MANUAL')|upper }}</span>
              {% if w.status and w.status != 'PENDING' %}
                <span class="badge" style="margin-left:6px">{{ w.status }}</span>
              {% endif %}
            </div>

            <div class="mono" style="max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
              {{ w.address or w.handle or w.destination or '—' }}
            </div>

            <div class="mono"><strong>{{ w.amount or 0 }}</strong></div>
            <div class="mono">{{ wallet.balance if wallet else 0 }}</div>
            <div class="mono">{{ w.created_at.strftime('%Y-%m-%d %H:%M') if w.created_at else '—' }}</div>

            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
              <form method="post" action="{{ url_for('employeebp.withdrawals_redeem', wd_id=w.id) }}"
                    onsubmit="return rowConfirm(this, 'Redeem on GameVault now?');">
                <button class="btn" type="submit">Redeem</button>
              </form>

              <form method="post" action="{{ url_for('employeebp.withdrawals_paid', wd_id=w.id) }}"
                    onsubmit="return rowConfirm(this, 'Mark as PAID and deduct wallet?');">
                <input class="input" type="number" name="tip_amount" placeholder="Tip"
                       style="width:84px" min="0" step="1">
                <button class="btn btn-primary" type="submit">Mark Paid</button>
              </form>

              <form method="post" action="{{ url_for('employeebp.withdrawals_reject', wd_id=w.id) }}"
                    onsubmit="return rowConfirm(this, 'Reject this withdrawal?');">
                <button class="btn btn-ghost" type="submit">Reject</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty">No pending withdrawals.</div>
    {% endif %}
  </div>

  {# ----------------------- RECENT ----------------------- #}
  <div class="panel" style="margin-top:14px">
    <div class="h4" style="margin-bottom:10px">Recent (last 30)</div>

    {% if recent %}
      <div class="table">
        <div class="t-head">
          <div>ID</div>
          <div>Player</div>
          <div>Game</div>
          <div>Method</div>
          <div>Destination</div>
          <div>Amount</div>
          <div>Status</div>
          <div>Updated</div>
        </div>

        {% for w in recent %}
          {% set user = users.get(w.user_id) %}
          {% set game = games.get(w.game_id) %}
          <div class="t-row">
            <div class="mono">#{{ w.id }}</div>
            <div>
              <div class="strong">{{ (user.name or user.email) if user else ('User #' ~ w.user_id) }}</div>
              {% if user and user.email %}
                <div class="muted mono" style="font-size:12px">{{ user.email }}</div>
              {% endif %}
            </div>
            <div>{{ game.name if game else '—' }}</div>
            <div><span class="badge">{{ (w.method or 'MANUAL')|upper }}</span></div>
            <div class="mono" style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
              {{ w.address or w.handle or w.destination or '—' }}
            </div>
            <div class="mono"><strong>{{ w.amount or 0 }}</strong></div>
            <div>
              {% if w.status == 'PAID' %}
                <span class="badge success">PAID</span>
              {% elif w.status == 'REJECTED' %}
                <span class="badge danger">REJECTED</span>
              {% elif w.status == 'APPROVED' %}
                <span class="badge">APPROVED</span>
              {% else %}
                <span class="badge">{{ w.status or '—' }}</span>
              {% endif %}
            </div>
            <div class="mono">
              {% if w.paid_at %}{{ w.paid_at.strftime('%Y-%m-%d %H:%M') }}
              {% else %}{{ w.updated_at.strftime('%Y-%m-%d %H:%M') if w.updated_at else (w.created_at.strftime('%Y-%m-%d %H:%M') if w.created_at else '—') }}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty">No recent activity.</div>
    {% endif %}
  </div>

</div>

<script>
function rowConfirm(formEl, msg){
  if(!confirm(msg)) return false;
  // disable all buttons in this form to avoid double-submit
  const btns = formEl.querySelectorAll('button[type="submit"]');
  btns.forEach(b => { b.disabled = true; b.textContent = 'Working…'; });
  return true;
}
</script>
{% endblock %}